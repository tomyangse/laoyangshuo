<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语音翻译到瑞典语</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', 'sans-serif';
        }
        /* 自定义麦克风按钮动画 */
        .mic-button.is-listening {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center min-h-screen transition-colors duration-500">

    <div class="w-full max-w-2xl mx-auto p-6 md:p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl space-y-8">
        <!-- 头部 -->
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-white">语音翻译</h1>
            <p class="text-gray-500 dark:text-gray-400 mt-2">将您说的话实时翻译成瑞典语</p>
        </div>

        <!-- 麦克风控制 -->
        <div class="flex justify-center py-4">
            <button id="micButton" class="mic-button w-24 h-24 bg-blue-600 hover:bg-blue-700 text-white rounded-full flex items-center justify-center transition-all duration-300 ease-in-out shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800">
                <svg id="micIcon" class="w-12 h-12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5a6 6 0 00-12 0v1.5a6 6 0 006 6z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12a7.5 7.5 0 11-15 0" />
                </svg>
                 <svg id="stopIcon" class="w-12 h-12 hidden" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5z"/>
                </svg>
            </button>
        </div>

        <!-- 状态和结果区域 -->
        <div class="space-y-6">
            <!-- 识别结果 -->
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg min-h-[80px]">
                <h2 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2">你说的话 (可编辑)：</h2>
                <textarea id="userInput" class="w-full h-auto bg-transparent border-none focus:ring-0 resize-none text-gray-800 dark:text-gray-200 text-lg leading-relaxed" rows="3" placeholder="请点击麦克风说话，或在此输入文字..."></textarea>
            </div>

            <!-- 翻译结果 -->
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg min-h-[80px] relative">
                 <h2 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2">瑞典语翻译：</h2>
                 <p id="translationOutput" class="text-gray-800 dark:text-gray-200 text-lg leading-relaxed"></p>
                 <div id="loadingSpinner" class="hidden absolute inset-0 bg-gray-50 dark:bg-gray-700 bg-opacity-80 flex justify-center items-center rounded-lg">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                 </div>
                 <button id="playButton" class="hidden absolute top-4 right-4 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.55 11.25l-5.625-3.375a1.125 1.125 0 00-1.688.938v6.75a1.125 1.125 0 001.688.938l5.625-3.375a1.125 1.125 0 000-1.876z" />
                    </svg>
                 </button>
            </div>
             <div id="errorMessage" class="hidden text-center p-2 rounded-lg"></div>
        </div>
    </div>

    <script>
        // DOM Elements
        const micButton = document.getElementById('micButton');
        const micIcon = document.getElementById('micIcon');
        const stopIcon = document.getElementById('stopIcon');
        const userInput = document.getElementById('userInput');
        const translationOutput = document.getElementById('translationOutput');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorMessage = document.getElementById('errorMessage');
        const playButton = document.getElementById('playButton');

        // State
        let isListening = false;
        let final_transcript = '';
        let debounceTimer;

        // Speech Recognition Setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            showNotification("抱歉，您的浏览器不支持语音识别功能。请尝试使用 Chrome 或 Edge 浏览器。");
            micButton.disabled = true;
        }
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        if (recognition) {
            recognition.lang = 'zh-CN';
            recognition.interimResults = true;
            recognition.continuous = true;
        }

        // Event Listeners
        micButton.addEventListener('click', () => isListening ? stopRecognition() : startRecognition());

        userInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            if (!isListening) {
                const text = userInput.value.trim();
                if (text) {
                    debounceTimer = setTimeout(() => translateToSwedish(text), 1200);
                } else {
                    translationOutput.textContent = '';
                    playButton.classList.add('hidden');
                }
            }
        });

        playButton.addEventListener('click', () => {
            const textToSpeak = translationOutput.textContent;
            if (textToSpeak && 'speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = 'sv-SE';
                window.speechSynthesis.speak(utterance);
            }
        });

        // Speech Recognition Handlers
        if (recognition) {
            recognition.onresult = (event) => {
                let interim_transcript = '';
                let temp_final = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        temp_final += event.results[i][0].transcript;
                    } else {
                        interim_transcript += event.results[i][0].transcript;
                    }
                }
                final_transcript = temp_final || final_transcript;
                userInput.value = final_transcript + interim_transcript;
            };

            recognition.onend = () => { if (isListening) stopRecognition(); };
            recognition.onerror = (event) => {
                showNotification(`语音识别错误: ${event.error}`, 'error');
                stopRecognition();
            };
        }

        // Core Functions
        function startRecognition() {
            if (!recognition) return;
            isListening = true;
            micButton.classList.add('is-listening', 'bg-red-600', 'hover:bg-red-700');
            micButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            micIcon.classList.add('hidden');
            stopIcon.classList.remove('hidden');
            
            final_transcript = '';
            userInput.value = '请开始说话...';
            translationOutput.textContent = '';
            playButton.classList.add('hidden');
            hideNotification();
            clearTimeout(debounceTimer);
            recognition.start();
        }

        function stopRecognition() {
            if (!recognition) return;
            isListening = false;
            micButton.classList.remove('is-listening', 'bg-red-600', 'hover:bg-red-700');
            micButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            micIcon.classList.remove('hidden');
            stopIcon.classList.add('hidden');
            recognition.stop();

            const textToTranslate = userInput.value.trim();
            if (textToTranslate && textToTranslate !== '请开始说话...') {
                translateToSwedish(textToTranslate);
            }
        }

        async function translateToSwedish(text) {
            loadingSpinner.classList.remove('hidden');
            translationOutput.textContent = '';
            playButton.classList.add('hidden');
            hideNotification();

            try {
                // 前端现在调用我们自己的后端函数，而不是直接调用 Google API
                const response = await fetch('/api/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text }) // 在请求体中发送文本
                });

                const result = await response.json();

                if (!response.ok) {
                    // 使用我们后端函数返回的错误信息
                    throw new Error(result.error || `请求失败，状态码：${response.status}`);
                }
                
                const translatedText = result.translation;
                translationOutput.textContent = translatedText;
                if(translatedText) {
                   playButton.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error("翻译时出错:", error);
                showNotification(`翻译失败: ${error.message}`, 'error');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }
        
        // UI Notification Functions
        function showNotification(message, type = 'error') {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            // Reset classes
            errorMessage.classList.remove('bg-red-100', 'text-red-700', 'dark:bg-red-900', 'dark:text-red-300');
            errorMessage.classList.add('bg-red-100', 'text-red-700', 'dark:bg-red-900', 'dark:text-red-300');
        }

        function hideNotification() {
            errorMessage.classList.add('hidden');
        }

    </script>
</body>
</html>
